<div class="feed-status-item">
    <span class="title">Current feed:</span>
    <form name="feed-selector-form" class="feed-status-form">
        <select id="feed-selector" name="feed" class="admin__control-select">
                <?php
                /**
                 * @var Magento\Framework\Escaper $escaper
                 * @var Magento\DataExporterStatus\Block\Adminhtml\FeedStatusInfo $block
                 */
                foreach ($block->getFeedOptions() as $option): ?>
                    <option value="<?= $escaper->escapeHtmlAttr($option['value']) ?>"
                            <?= $option['value'] === $block->getCurrentFeedName() ? 'selected="selected"' : '' ?>>
                        <?= $escaper->escapeHtml($option['label']) ?>
                    </option>
                <?php endforeach; ?>
        </select>
    </form>
</div>
<div class="feed-status-item">
    <span class="title">Indexer status:</span>
    <?php
        $statusText = $block->getFormattedIndexerStatus();
    ?>
        <?php if ($block->isIndexerInvalid() || $block->isIndexerInProgress()): ?>
            <span class="warning-status"><?= $escaper->escapeHtml($statusText) ?></span>
        <?php else: ?>
            <span class="ok-status"><?= $escaper->escapeHtml($statusText) ?></span>
        <?php endif; ?>
</div>
<div class="feed-status-item">
    <span class="title">Changelog backlog:</span>
    <?php
    $backlogCount = $block->getChangelogBacklogCount();
    $class = $backlogCount > 1000 ? 'error-status' : 'warning-status';
    if ($backlogCount > 0): ?>
        <span class="<?=$class?>"><?= $escaper->escapeHtml($backlogCount) ?> item(s) in backlog, last updated <?= $block->getChangelogLastUpdated()?></span>
    <?php else: ?>
        <span class="ok-status">All synced</span>
    <?php endif; ?>
</div>
<?php if (!$block->isScheduleModeEnabled()):?>
    <div class="feed-status-item">
        <span class="title">Indexer mode:</span>
         <span class="error-status">"Realtime" mode is not expected. Risk of data loss</span>
    </div>
<?php endif;?>

<script type="text/javascript">
require(['jquery'], function($) {
    $(document).ready(function() {
        $('#feed-selector').on('change', function() {
            let feedName = $(this).val();
            if (feedName && feedName !== '') {
                let currentPath = window.location.pathname, newPath;
                
                // Handle URL structure: /admin/data_exporter_status/FeedStatus/index/feed/products/key/xxx/
                if (currentPath.includes('/feed/')) {
                    // Replace existing feed: /feed/products/key/xxx -> /feed/categories/key/xxx
                    newPath = currentPath.replace(/\/feed\/[^\/]+/, '/feed/' + feedName);
                } else {
                    // Insert feed before key: /index/key/xxx -> /index/feed/categories/key/xxx
                    newPath = currentPath.replace(/\/key\//, '/feed/' + feedName + '/key/');
                }
                
                window.location.href = newPath;
            }
        });
    });
});
</script>